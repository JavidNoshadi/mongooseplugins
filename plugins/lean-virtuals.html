
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>Mongoose Plugins Search</title>
    <link rel="stylesheet" href="/public/style.css">

    <script type="text/javascript">
      !function(name,path,ctx){
        var latest,prev=name!=='Keen'&&window.Keen?window.Keen:false;ctx[name]=ctx[name]||{ready:function(fn){var h=document.getElementsByTagName('head')[0],s=document.createElement('script'),w=window,loaded;s.onload=s.onerror=s.onreadystatechange=function(){if((s.readyState&&!(/^c|loade/.test(s.readyState)))||loaded){return}s.onload=s.onreadystatechange=null;loaded=1;latest=w.Keen;if(prev){w.Keen=prev}else{try{delete w.Keen}catch(e){w.Keen=void 0}}ctx[name]=latest;ctx[name].ready(fn)};s.async=1;s.src=path;h.parentNode.insertBefore(s,h)}}
      }('KeenAsync','https://d26b395fwzu5fz.cloudfront.net/keen-tracking-1.1.3.min.js',this);

      KeenAsync.ready(function(){
        var client = new KeenAsync({
          projectId: '5ac79d81c9e77c0001a02e1d',
          writeKey: '3A2D0DE1DA53EAE8EDB843737C817C0285F1D7DECEE598E50D42D2F2D3213484D7A1303570E2F989EE0C3DAE48A5FFD967F70561E9B41B04B011AA5B1D8CA20FA0E0450B16F2DBC6E7C31465DE4C78F606ADAAD6365AC462EA549CF8BE2E7119'
        });

        // Record an event
        client.recordEvent('pageviews', {
          url: window.location.pathname
        });
      });
    </script>
  </head>
  <body>
    <div id="wrap">
      
    <script type="text/javascript" src="/public/native.js"></script>
    <link rel="stylesheet" href="/public/inlinecpc.css">
    <link rel="stylesheet" href="/public/highlight.css">
    <link rel="stylesheet" href="/public/plugin.css">
    <style>
      a, a:visited {
        color: #0366d6;
      }
    </style>

    <script>
      _native.init("CK7DT53Y",{
        targetClass: 'native-inline'
      });
    </script>

    <div class="content">
      <div class="toc">
        <h2><a href="/">Mongoose Plugins</a></h2>
        <div>
          <div id="select-plugin"><a class="select-plugin-this-repo" href="./lean-virtuals">mongoose-lean-virtuals</a> <span class="right-arrow"></span><div id="select-plugin-hidden"><a href="./autopopulate">mongoose-autopopulate</a></div></div>
        </div>
        <ul>
<li><a href="#usage">Usage</a></li>
<li><a href="#examples">examples</a><ul>
<li><a href="#it-attaches-virtuals-to-result-of-find-findone-findbyid-findbyidandupdate-and-findoneandupdate-if-lean">It attaches virtuals to result of find, findOne, findById, findByIdAndUpdate, and findOneAndUpdate if lean</a></li>
<li><a href="#it-lets-you-choose-which-virtuals-to-apply">It lets you choose which virtuals to apply</a></li>
</ul>
</li>
<li><a href="#changelog">Changelog</a><ul>
<li><a href="#030--2018-01-29">0.3.0 / 2018-01-29</a></li>
</ul>
</li>
</ul>

        <div id="carbonads-wrapper">
          <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DT537&placement=mongoosejsio" id="_carbonads_js"></script>
        </div>
      </div>
      <h1>mongoose-lean-virtuals</h1>
      <div class="native-inline">
        <a href="#native_link#"><span class="sponsor">Sponsor</span> #native_company# â€” #native_desc#</a>
      </div>
      <h1 id="usage">Usage</h1>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> mongooseLeanVirtuals = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose-lean-virtuals'</span>);

<span class="hljs-comment">// Example schema</span>
<span class="hljs-keyword">const</span> userSchema = <span class="hljs-keyword">new</span> mongoose.Schema({ <span class="hljs-attr">name</span>: <span class="hljs-built_in">String</span> });

userSchema.virtual(<span class="hljs-string">'lowercase'</span>).get(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.name.toLowerCase();
});

<span class="hljs-comment">// Now, the `lowercase` property will show up even if you do a lean query</span>
userSchema.plugin(mongooseLeanVirtuals);

<span class="hljs-comment">// Later</span>

<span class="hljs-comment">// You **must** pass `virtuals: true` to `lean()`, otherwise `lowercase`</span>
<span class="hljs-comment">// won't be in `res`</span>
<span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> UserModel.find().lean({ <span class="hljs-attr">virtuals</span>: <span class="hljs-literal">true</span> });</code></pre>


      

<h1 id="examples">examples</h1>


<h2 id="it-attaches-virtuals-to-result-of-find-findone-findbyid-findbyidandupdate-and-findoneandupdate-if-lean">It attaches virtuals to result of find, findOne, findById, findByIdAndUpdate, and findOneAndUpdate if lean</h2>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> schema = <span class="hljs-keyword">new</span> mongoose.Schema({
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">String</span>
});

schema.virtual(<span class="hljs-string">'lowercase'</span>).get(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.name.toLowerCase();
});

schema.plugin(mongooseLeanVirtuals);

<span class="hljs-keyword">const</span> Model = mongoose.model(<span class="hljs-string">'Test'</span>, schema);

<span class="hljs-keyword">return</span> Model.create({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Val'</span> }).
  then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-built_in">Promise</span>.all([
    <span class="hljs-comment">// You **must** pass `virtuals: true` to `lean()`</span>
    Model.find().lean({ <span class="hljs-attr">virtuals</span>: <span class="hljs-literal">true</span> }),
    Model.findOne().lean({ <span class="hljs-attr">virtuals</span>: <span class="hljs-literal">true</span> }),
    Model.findOneAndUpdate({}, { <span class="hljs-attr">name</span>: <span class="hljs-string">'VAL'</span> }).lean({ <span class="hljs-attr">virtuals</span>: <span class="hljs-literal">true</span> })
  ])).
  then(<span class="hljs-function"><span class="hljs-params">results</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> [findRes, findOneRes, findOneAndUpdateRes] = results;
    assert.equal(findRes[<span class="hljs-number">0</span>].lowercase, <span class="hljs-string">'val'</span>);
    assert.equal(findOneRes.lowercase, <span class="hljs-string">'val'</span>);
    assert.equal(findOneAndUpdateRes.lowercase, <span class="hljs-string">'val'</span>);

    <span class="hljs-comment">// Mongoose has an `id` virtual by default that gets the `_id` as a</span>
    <span class="hljs-comment">// string.</span>
    assert.equal(findRes[<span class="hljs-number">0</span>].id, findRes[<span class="hljs-number">0</span>]._id.toString());
    assert.equal(findOneRes.id, findOneRes._id.toString());
    assert.equal(findOneAndUpdateRes.id, findOneAndUpdateRes._id.toString());
  });</code></pre>


<h2 id="it-lets-you-choose-which-virtuals-to-apply">It lets you choose which virtuals to apply</h2>
<p>If you specify a list of virtuals in <code>lean()</code>, this plugin will only
apply those virtuals. This lets you pick which virtuals show up.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> schema = <span class="hljs-keyword">new</span> mongoose.Schema({
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">String</span>
}, { <span class="hljs-attr">id</span>: <span class="hljs-literal">false</span> });

schema.virtual(<span class="hljs-string">'lowercase'</span>).get(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.name.toLowerCase();
});
schema.virtual(<span class="hljs-string">'uppercase'</span>).get(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.name.toUpperCase();
});

schema.plugin(mongooseLeanVirtuals);

<span class="hljs-keyword">const</span> Model = mongoose.model(<span class="hljs-string">'Test2'</span>, schema);

<span class="hljs-keyword">return</span> Model.create({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Val'</span> }).
  then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> Model.findOne().lean({ <span class="hljs-attr">virtuals</span>: [<span class="hljs-string">'uppercase'</span>] })).
  then(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
    assert.equal(result.uppercase, <span class="hljs-string">'VAL'</span>);
    assert.ok(!result.lowercase);
  });</code></pre>


      <h1 id="changelog">Changelog</h1>
<h2 id="0-3-0-2018-01-29">0.3.0 / 2018-01-29</h2>
<ul>
<li>fix: delay checking virtuals until the middleware for 5.0 support #6</li>
</ul>

    </div>
  
    </div>
  </body>
</html>
